<html>
<head>
<script type="text/javascript" charset="utf-8">
  chrome.extension.onConnect.addListener(function(port, name) {
    if (port.name == "nativeCommand")
      port.onMessage.addListener(handleNativeCommand);
    else if (port.name == "keyDown")
      port.onMessage.addListener(handleKeyDown);
  });
  
  function handleNativeCommand(args) {
    console.log("received native command:", args);

    switch(args.command) {
      case "tabs.create":
        chrome.tabs.create({});
      break;
      case "tabs.remove":
        console.log("removing");
        chrome.tabs.getSelected(null, function(tab) {
          chrome.tabs.remove(tab.id);
        });
      break;
    }
  }

  function createTab() {
    console.log("createTab()");
    chrome.tabs.create({});
  }

  function removeTab() {
    console.log("removeTab()");
    chrome.tabs.getSelected(null, function(tab) { chrome.tabs.remove(tab.id); });
  }

  var keyToCommandRegistry = {};
  keyToCommandRegistry['gg'] = {command: 'scrollToTop'};
  keyToCommandRegistry['G']  = {command: 'scrollToBottom'};
  keyToCommandRegistry['t']  = {command: createTab};
  keyToCommandRegistry['d']  = {command: removeTab};

  var commandRegistry = {}; 
  var keyQueue = "";

  function handleKeyDown(key) {
    keyQueue = keyQueue + key;
    console.log("current keyQueue: [", keyQueue, "]");
    checkKeyQueue();
  }

  function checkKeyQueue() {
    if (keyToCommandRegistry[keyQueue])
    {
      registryEntry = keyToCommandRegistry[keyQueue];
      console.log("command found for [", keyQueue, "],", registryEntry.command);

      if (typeof(registryEntry.command) == "string")
      {
        chrome.tabs.getSelected(null, function (tab) {
          var port = chrome.tabs.connect(tab.id, {name: "executePageCommand"});
          port.postMessage({command: registryEntry.command});
        });
      }
      else { registryEntry.command.call(); }
      
      keyQueue = "";
    }
    else if (keyQueue.length > 1)
      keyQueue = "";
  }
</script>

</head>

<body>
  howdy
</body>

</html>
