<html>
<head>
<script type="text/javascript" charset="utf-8">
  var tabQueue = [];
  var keyQueue = "";

  chrome.extension.onConnect.addListener(function(port, name) {
    if (port.name == "keyDown")
      port.onMessage.addListener(handleKeyDown);
  });
  
  function createTab() { chrome.tabs.create({}); }

  function removeTab() {
    chrome.tabs.getSelected(null, function(tab) {
                                      tabQueue.push(tab.url);
                                      chrome.tabs.remove(tab.id);
                                  });
  }

  function restoreTab() {
    if (tabQueue.length > 0) { chrome.tabs.create({url: tabQueue.pop()}); }
  }

  var keyToCommandRegistry = {};
  keyToCommandRegistry['j']  = 'scrollDown';
  keyToCommandRegistry['k']  = 'scrollUp';
  keyToCommandRegistry['h']  = 'scrollLeft';
  keyToCommandRegistry['l']  = 'scrollRight';
  keyToCommandRegistry['gg'] = 'scrollToTop';
  keyToCommandRegistry['G']  = 'scrollToBottom';
  keyToCommandRegistry['r']  = 'reload';
  keyToCommandRegistry['t']  = createTab;
  keyToCommandRegistry['d']  = removeTab;
  keyToCommandRegistry['u']  = restoreTab;

  function handleKeyDown(key) {
    keyQueue = keyQueue + key;
    console.log("current keyQueue: [", keyQueue, "]");
    checkKeyQueue();
  }

  function checkKeyQueue() {
    if (keyToCommandRegistry[keyQueue])
    {
      registryEntry = keyToCommandRegistry[keyQueue];
      console.log("command found for [", keyQueue, "],", registryEntry);

      if (typeof(registryEntry) == "string")
      {
        chrome.tabs.getSelected(null, function (tab) {
          var port = chrome.tabs.connect(tab.id, {name: "executePageCommand"});
          port.postMessage({command: registryEntry});
        });
      }
      else { registryEntry.call(); }
      
      keyQueue = "";
    }
    else if (keyQueue.length > 1)
      keyQueue = "";
  }
</script>

</head>

<body>
  howdy
</body>

</html>
